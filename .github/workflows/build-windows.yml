name: Build Windows Executable

on:
  push:
    tags:
      - 'v*'  # 推送 tag 时触发，如 v1.0.0
  workflow_dispatch:  # 手动触发

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build executable
        run: |
          pyinstaller --name="ChanTrader" `
            --onedir `
            --windowed `
            --noconfirm `
            --clean `
            --add-data="App;App" `
            --add-data="Bi;Bi" `
            --add-data="BuySellPoint;BuySellPoint" `
            --add-data="ChanModel;ChanModel" `
            --add-data="Combiner;Combiner" `
            --add-data="Common;Common" `
            --add-data="DataAPI;DataAPI" `
            --add-data="KLine;KLine" `
            --add-data="Math;Math" `
            --add-data="Plot;Plot" `
            --add-data="Seg;Seg" `
            --add-data="ZS;ZS" `
            --add-data="Chan.py;." `
            --add-data="ChanConfig.py;." `
            --add-data="__init__.py;." `
            --hidden-import=Chan `
            --hidden-import=ChanConfig `
            --hidden-import=ChanModel `
            --hidden-import=ChanModel.Features `
            --hidden-import=ChanModel.XGBModel `
            --hidden-import=Common `
            --hidden-import=Common.CEnum `
            --hidden-import=Common.CTime `
            --hidden-import=Common.ChanException `
            --hidden-import=Common.func_util `
            --hidden-import=DataAPI `
            --hidden-import=DataAPI.CommonStockAPI `
            --hidden-import=DataAPI.AkshareAPI `
            --hidden-import=DataAPI.BaoStockAPI `
            --hidden-import=KLine `
            --hidden-import=KLine.KLine `
            --hidden-import=KLine.KLine_Unit `
            --hidden-import=KLine.KLine_List `
            --hidden-import=Math `
            --hidden-import=Math.BOLL `
            --hidden-import=Math.Demark `
            --hidden-import=Math.KDJ `
            --hidden-import=Math.MACD `
            --hidden-import=Math.RSI `
            --hidden-import=Math.TrendLine `
            --hidden-import=Plot `
            --hidden-import=Plot.PlotDriver `
            --hidden-import=Plot.PlotMeta `
            --hidden-import=Plot.AnimatePlotDriver `
            --hidden-import=BuySellPoint `
            --hidden-import=BuySellPoint.BS_Point `
            --hidden-import=BuySellPoint.BSPointList `
            --hidden-import=Seg `
            --hidden-import=Seg.Seg `
            --hidden-import=Seg.SegListComm `
            --hidden-import=ZS `
            --hidden-import=ZS.ZS `
            --hidden-import=ZS.ZSList `
            --hidden-import=Bi `
            --hidden-import=Bi.Bi `
            --hidden-import=Bi.BiList `
            --hidden-import=Combiner `
            --hidden-import=Combiner.KLine_Combiner `
            --hidden-import=akshare `
            --hidden-import=baostock `
            --hidden-import=pandas `
            --hidden-import=numpy `
            --hidden-import=matplotlib `
            --hidden-import=matplotlib.pyplot `
            --hidden-import=matplotlib.figure `
            --hidden-import=matplotlib.backends.backend_tkagg `
            --hidden-import=matplotlib.patches `
            --hidden-import=tkinter `
            --hidden-import=tkinter.ttk `
            --hidden-import=tkinter.messagebox `
            --hidden-import=tkinter.filedialog `
            --hidden-import=chan_viewer_tk `
            --hidden-import=chan_viewer_multilevel_tk `
            --hidden-import=stock_history `
            --collect-submodules=akshare `
            --collect-submodules=baostock `
            --collect-data=akshare `
            --collect-data=baostock `
            --paths=. `
            --paths=App `
            App/chan_app.py

      - name: Create zip archive
        run: |
          Compress-Archive -Path dist/ChanTrader/* -DestinationPath dist/ChanTrader-Windows.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ChanTrader-Windows
          path: dist/ChanTrader-Windows.zip

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: dist/ChanTrader-Windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
